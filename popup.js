// Copyright (c) 2014 The Chromium Authors. All rights reserved.// Use of this source code is governed by a BSD-style license that can be// found in the LICENSE file.document.addEventListener('DOMContentLoaded', function () {      document.getElementById('add').addEventListener('click', save);	  document.getElementById('disp').addEventListener('click', display);});/*	URL		*/var og_url;chrome.tabs.query({ 'active': true,  'lastFocusedWindow': true}, function (tabs) {og_url = tabs[0].url;});/*	Titre et Vignette	*/var og_titre;var og_description;var og_urlImage;chrome.runtime.onMessage.addListener(function(request, sender) {	if (request.action == "getSource") 	{		message.innerText = "Traitement des infos...";//		console.log(request.source); //affiche le code source dans la console				var el = document.createElement( 'html' );		el.innerHTML = request.source;				var allMetas = el.getElementsByTagName("meta");		for (var i = 0, n = allMetas.length; i < n; i++)		{			switch(allMetas[i].getAttribute('property'))			{				case 'og:title':					og_titre = allMetas[i].content;					break;				case 'og:description':					og_description = allMetas[i].content;					break;				case 'og:image':					og_urlImage = allMetas[i].content;					if (og_urlImage.startsWith("//"))		//leboncoin..					{						og_urlImage = "http:"+og_urlImage;					}					break;			}			switch(allMetas[i].getAttribute('name'))		//pour LDLC			{				case 'og:title':					og_titre = allMetas[i].content;					break;				case 'og:description':					og_description = allMetas[i].content;					break;				case 'og:image':					og_urlImage = allMetas[i].content;					if (og_urlImage.startsWith("//"))					{						og_urlImage = "http:"+og_urlImage;					}					break;			}		}				if(!og_titre) 	//pour youtube		{			var all = el.getElementsByTagName("link");			for (var i = 0, n = all.length; i < n; i++)			{				if (all[i].getAttribute('itemprop') == 'thumbnailUrl')				{	og_urlImage = all[i].href	}			}			all = el.getElementsByTagName('meta');			for (var i = 0, n = all.length; i < n; i++)			{				if (all[i].getAttribute('itemprop') == 'name')				{	og_titre = all[i].content	}			}		}		if(!og_titre)	//si pas de titre spécial og..		{			og_titre = el.getElementsByTagName('title')[0].innerHTML;		}				if(!og_urlImage)	//si pas d'image prévue, on tente l'icone..		{			var all = el.getElementsByTagName("link");			for (var i = 0, n = all.length; i < n; i++)			{				if (all[i].getAttribute('rel') == 'icon' || all[i].getAttribute('rel') == 'shortcut icon' )				{						og_urlImage = all[i].getAttribute("href");					if (og_urlImage.indexOf("/") == 0)					{	og_urlImage = extractDomain(og_url) + og_urlImage;					}					}			}		}		console.log(og_urlImage);						titre.textContent = og_titre;	 	//affichage titre		titre.href = og_url;				if(og_urlImage) 	//affichage vignette		{		vignette = document.getElementById('vignette');		vignette.src = og_urlImage;		message.innerText = "";		}		else		{	message.innerText = "no image found";	}			/*pré-remplissage prix*/	var pre_prix;		var allpx = el.getElementsByTagName('h2');		//leboncoin !			for (var i = 0, n = allpx.length; i < n; i++)		{			if (allpx[i].getAttribute('itemprop') == "price")			{					pre_prix = allpx[i].getAttribute('content') + " €";				break;			}		}			allpx = el.getElementsByTagName('div');	//airbnb	for (var i = 0, n = allpx.length; i < n; i++)	{		if (allpx[i].getAttribute('data-hypernova-key') == "p3listing_pricebundlejs")		{				console.log(allpx[i]);			pre_prix = allpx[i].textContent;			pre_prix = pre_prix.substring(0, pre_prix.indexOf('Par'))+" p"+pre_prix.substring(pre_prix.indexOf('Par')+1);			break;		}	}		if(pre_prix)	{		document.getElementById('champ1').value = pre_prix;		}					/*pré-remplissage tel*/	var pre_tel		var alltel = el.getElementsByTagName('span'); //leboncoin	for (var i = 0, n = alltel.length; i < n; i++)		{			if (alltel[i].getAttribute('class') == "phone_number font-size-up")			{					pre_tel = alltel[i].textContent;				break;			}		}	if(pre_tel)	{		document.getElementById('champ2').value = pre_tel;	}				}});function extractDomain(url) {    var domain;    //find & remove protocol (http, ftp, etc.) and get domain    if (url.indexOf("://") > -1) {        domain = url.split('/')[2];    }    else {        domain = url.split('/')[0];    }    //find & remove port number    domain = domain.split(':')[0];    return domain;}function onWindowLoad() {	var message = document.querySelector('#message');	chrome.tabs.executeScript(null, {		file: "getPagesSource.js"	}, function() {		if (chrome.runtime.lastError) {			message.innerText = "Erreur d'analyse de la page : \n" + chrome.runtime.lastError.message;		}	});}window.onload = onWindowLoad;/*	Boutons		*/function save() {	if(og_titre)	{		var newItem =			{				url: og_url,				titre: og_titre,				urlVignette: og_urlImage,				chp1: "-",				chp2: "-",				chp3: "-"			}					if(document.getElementById("champ1").value)			{	newItem.chp1 = document.getElementById("champ1").value	}		if(document.getElementById("champ2").value)			{	newItem.chp2 = document.getElementById("champ2").value	}		if(document.getElementById("champ3").value)			{	newItem.chp3 = document.getElementById("champ3").value	}		console.log(newItem);		chrome.storage.sync.get('fullcomp', function(result) 			{				var liste = [];			if (result.fullcomp){liste = result.fullcomp};			liste.push(newItem);			chrome.storage.sync.set({'fullcomp' : liste}, function() {});			});	}			}function display() {    chrome.tabs.create({url: "display.html"});   }